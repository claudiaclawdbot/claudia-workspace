import { useState, useEffect } from 'react';
import Head from 'next/head';
import Link from 'next/link';
import type { GetServerSideProps } from 'next';
import { 
  Activity, 
  Plus, 
  RefreshCw, 
  Server, 
  CheckCircle2, 
  Clock, 
  AlertCircle,
  Cpu,
  Layers,
  Zap,
  MoreHorizontal,
  MessageSquare,
  Terminal,
  ArrowRight,
  LayoutDashboard
} from 'lucide-react';
import { getAllAgentData } from '../lib/data';

interface Agent {
  id: string;
  name: string;
  task: string;
  status: 'active' | 'pending' | 'completed' | 'error';
  started: string;
  sessionKey: string;
  model?: string;
  tokens?: string;
  age?: string;
}

interface Stats {
  activeCount: number;
  completedCount: number;
  totalTokens: number;
  maxParallel: number;
  apiStatus: string;
  cronStatus: string;
  skillsAvailable: number;
}

interface CompletedTask {
  name: string;
  description: string;
}

interface PendingTask {
  name: string;
  description: string;
  waitingFor?: string;
}

interface DashboardProps {
  initialData: {
    agents: Agent[];
    completed: CompletedTask[];
    pending: PendingTask[];
    stats: Stats;
    lastUpdated: string;
  };
}

export default function Dashboard({ initialData }: DashboardProps) {
  const [agents, setAgents] = useState<Agent[]>(initialData.agents || []);
  const [stats, setStats] = useState<Stats | null>(initialData.stats || null);
  const [completed, setCompleted] = useState<CompletedTask[]>(initialData.completed || []);
  const [pending, setPending] = useState<PendingTask[]>(initialData.pending || []);
  const [lastUpdated, setLastUpdated] = useState<string>(initialData.lastUpdated || '');
  const [isLoading, setIsLoading] = useState(false);
  const [autoRefresh, setAutoRefresh] = useState(true);
  const [showSpawnModal, setShowSpawnModal] = useState(false);

  // Form state
  const [spawnName, setSpawnName] = useState('');
  const [spawnTask, setSpawnTask] = useState('');
  const [spawnPriority, setSpawnPriority] = useState('normal');

  const fetchData = async () => {
    try {
      const res = await fetch('/api/agents');
      const data = await res.json();
      setAgents(data.agents || []);
      setStats(data.stats || null);
      setCompleted(data.completed || []);
      setPending(data.pending || []);
      setLastUpdated(data.lastUpdated || '');
    } catch (e) {
      console.error('Failed to fetch data:', e);
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
    
    if (autoRefresh) {
      const interval = setInterval(fetchData, 5000);
      return () => clearInterval(interval);
    }
  }, [autoRefresh]);

  const handleSpawn = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const res = await fetch('/api/spawn', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: spawnName, task: spawnTask, priority: spawnPriority }),
      });
      
      if (res.ok) {
        setShowSpawnModal(false);
        setSpawnName('');
        setSpawnTask('');
        fetchData();
      }
    } catch (e) {
      console.error('Failed to spawn agent:', e);
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'active': return 'bg-success';
      case 'pending': return 'bg-warning';
      case 'completed': return 'bg-primary';
      case 'error': return 'bg-error';
      default: return 'bg-textMuted';
    }
  };

  const getStatusText = (status: string) => {
    switch (status) {
      case 'active': return 'Active';
      case 'pending': return 'Pending';
      case 'completed': return 'Completed';
      case 'error': return 'Error';
      default: return status;
    }
  };

  return (
    <div className="min-h-screen bg-background">
      <Head>
        <title>Agent Dashboard | OpenClaw</title>
      </Head>

      {/* Header */}
      <header className="border-b border-border bg-surface/50 backdrop-blur">
        <div className="max-w-7xl mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-accent1 flex items-center justify-center">
                <Cpu className="w-5 h-5 text-white" />
              </div>
              <div>
                <h1 className="text-xl font-bold gradient-text">Agent Dashboard</h1>
                <p className="text-sm text-textMuted">OpenClaw Orchestrator</p>
              </div>
            </div>
            
            <div className="flex items-center gap-4">
              <button
                onClick={() => setAutoRefresh(!autoRefresh)}
                className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm transition-colors ${
                  autoRefresh ? 'bg-success/20 text-success' : 'bg-surfaceHover text-textMuted'
                }`}
              >
                <RefreshCw className={`w-4 h-4 ${autoRefresh ? 'animate-spin' : ''}`} style={{ animationDuration: '3s' }} />
                Auto-refresh {autoRefresh ? 'ON' : 'OFF'}
              </button>
              
              <button
                onClick={fetchData}
                className="p-2 rounded-lg bg-surfaceHover text-textMuted hover:text-text transition-colors"
              >
                <RefreshCw className="w-4 h-4" />
              </button>
              
              <button
                onClick={() => setShowSpawnModal(true)}
                className="btn btn-primary"
              >
                <Plus className="w-4 h-4" />
                Spawn Agent
              </button>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-6 py-8">
        {/* Stats Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
          <div className="glass-card p-5">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-textMuted text-sm mb-1">Active Agents</p>
                <p className="text-3xl font-bold text-text">{stats?.activeCount || 0}</p>
                <p className="text-success text-xs mt-1 flex items-center gap-1">
                  <Activity className="w-3 h-3" />
                  {stats ? `${stats.activeCount}/${stats.maxParallel} slots` : '...'}
                </p>
              </div>
              <div className="w-12 h-12 rounded-xl bg-success/10 flex items-center justify-center">
                <Activity className="w-6 h-6 text-success" />
              </div>
            </div>
          </div>

          <div className="glass-card p-5">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-textMuted text-sm mb-1">Completed Today</p>
                <p className="text-3xl font-bold text-text">{stats?.completedCount || 0}</p>
                <p className="text-primary text-xs mt-1 flex items-center gap-1">
                  <CheckCircle2 className="w-3 h-3" />
                  tasks finished
                </p>
              </div>
              <div className="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center">
                <CheckCircle2 className="w-6 h-6 text-primary" />
              </div>
            </div>
          </div>

          <div className="glass-card p-5">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-textMuted text-sm mb-1">Token Usage</p>
                <p className="text-3xl font-bold text-text">
                  {stats?.totalTokens ? `${(stats.totalTokens / 1000).toFixed(0)}k` : '0'}
                </p>
                <p className="text-accent2 text-xs mt-1 flex items-center gap-1">
                  <Zap className="w-3 h-3" />
                  total tokens
                </p>
              </div>
              <div className="w-12 h-12 rounded-xl bg-accent2/10 flex items-center justify-center">
                <Zap className="w-6 h-6 text-accent2" />
              </div>
            </div>
          </div>

          <div className="glass-card p-5">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-textMuted text-sm mb-1">System Health</p>
                <p className="text-3xl font-bold text-success">Online</p>
                <p className="text-textMuted text-xs mt-1 flex items-center gap-1">
                  <Server className="w-3 h-3" />
                  API operational
                </p>
              </div>
              <div className="w-12 h-12 rounded-xl bg-success/10 flex items-center justify-center">
                <Server className="w-6 h-6 text-success" />
              </div>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Active Agents */}
          <div className="lg:col-span-2 space-y-4">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-semibold text-text flex items-center gap-2">
                <Layers className="w-5 h-5 text-primary" />
                Active Agents
              </h2>
              <span className="text-sm text-textMuted">
                Last updated: {lastUpdated || 'Just now'}
              </span>
            </div>

            {isLoading ? (
              <div className="glass-card p-12 flex items-center justify-center">
                <div className="flex flex-col items-center gap-3">
                  <RefreshCw className="w-8 h-8 text-primary animate-spin" />
                  <p className="text-textMuted">Loading agents...</p>
                </div>
              </div>
            ) : agents.length === 0 ? (
              <div className="glass-card p-12 text-center">
                <div className="w-16 h-16 rounded-full bg-surfaceHover flex items-center justify-center mx-auto mb-4">
                  <Activity className="w-8 h-8 text-textMuted" />
                </div>
                <h3 className="text-lg font-medium text-text mb-2">No active agents</h3>
                <p className="text-textMuted text-sm mb-4">
                  All agents are idle. Spawn a new agent to get started.
                </p>
                <button
                  onClick={() => setShowSpawnModal(true)}
                  className="btn btn-primary"
                >
                  <Plus className="w-4 h-4" />
                  Spawn Agent
                </button>
              </div>
            ) : (
              <div className="space-y-3">
                {agents.map((agent) => (
                  <Link
                    key={agent.id}
                    href={`/agents/${agent.id}`}
                    className="glass-card p-4 flex items-center gap-4 hover:border-primary/50 transition-all group"
                  >
                    <div className="relative">
                      <div className="w-10 h-10 rounded-xl bg-surfaceHover flex items-center justify-center">
                        <Cpu className="w-5 h-5 text-primary" />
                      </div>
                      <div className={`absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2 border-surface ${getStatusColor(agent.status)} status-dot`} />
                    </div>
                    
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        <h3 className="font-medium text-text truncate">{agent.name}</h3>
                        <span className={`text-xs px-2 py-0.5 rounded-full ${
                          agent.status === 'active' ? 'bg-success/20 text-success' : 
                          agent.status === 'pending' ? 'bg-warning/20 text-warning' :
                          'bg-primary/20 text-primary'
                        }`}>
                          {getStatusText(agent.status)}
                        </span>
                      </div>
                      <p className="text-sm text-textMuted truncate">{agent.task}</p>
                    </div>
                    
                    <div className="hidden md:flex items-center gap-6 text-sm text-textMuted">
                      <div className="flex items-center gap-1.5">
                        <Clock className="w-4 h-4" />
                        <span>{agent.started || agent.age || 'Just now'}</span>
                      </div>
                      {agent.model && (
                        <div className="flex items-center gap-1.5">
                          <Zap className="w-4 h-4" />
                          <span className="truncate max-w-[120px]">{agent.model}</span>
                        </div>
                      )}
                    </div>
                    
                    <ArrowRight className="w-5 h-5 text-textMuted group-hover:text-primary transition-colors" />
                  </Link>
                ))}
              </div>
            )}
          </div>

          {/* Sidebar */}
          <div className="space-y-6">
            {/* Pending Tasks */}
            <div className="glass-card p-5">
              <h3 className="font-semibold text-text mb-4 flex items-center gap-2">
                <Clock className="w-4 h-4 text-warning" />
                Pending Tasks ({pending.length})
              </h3>
              
              {pending.length === 0 ? (
                <p className="text-textMuted text-sm">No pending tasks</p>
              ) : (
                <div className="space-y-3">
                  {pending.map((task, i) => (
                    <div key={i} className="p-3 rounded-lg bg-surfaceHover/50 border border-border">
                      <p className="text-sm font-medium text-text mb-1">{task.name}</p>
                      <p className="text-xs text-textMuted mb-1">{task.description}</p>
                      {task.waitingFor && (
                        <p className="text-xs text-warning">
                          Waiting for: {task.waitingFor}
                        </p>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Completed Tasks */}
            <div className="glass-card p-5">
              <h3 className="font-semibold text-text mb-4 flex items-center gap-2">
                <CheckCircle2 className="w-4 h-4 text-success" />
                Completed Today ({completed.length})
              </h3>
              
              {completed.length === 0 ? (
                <p className="text-textMuted text-sm">No completed tasks today</p>
              ) : (
                <div className="space-y-2">
                  {completed.slice(0, 5).map((task, i) => (
                    <div key={i} className="flex items-start gap-2 p-2 rounded hover:bg-surfaceHover/50 transition-colors">
                      <CheckCircle2 className="w-4 h-4 text-success mt-0.5 flex-shrink-0" />
                      <div>
                        <p className="text-sm text-text">{task.name}</p>
                        <p className="text-xs text-textMuted">{task.description.slice(0, 60)}...</p>
                      </div>
                    </div>
                  ))}
                  {completed.length > 5 && (
                    <p className="text-xs text-textMuted text-center pt-2">
                      +{completed.length - 5} more tasks
                    </p>
                  )}
                </div>
              )}
            </div>

            {/* Quick Actions */}
            <div className="glass-card p-5">
              <h3 className="font-semibold text-text mb-4">Quick Actions</h3>
              <div className="space-y-2">
                <button className="w-full p-3 rounded-lg bg-surfaceHover hover:bg-surfaceHover/80 transition-colors flex items-center gap-3 text-sm text-text">
                  <Terminal className="w-4 h-4 text-primary" />
                  View System Logs
                </button>
                <button className="w-full p-3 rounded-lg bg-surfaceHover hover:bg-surfaceHover/80 transition-colors flex items-center gap-3 text-sm text-text">
                  <MessageSquare className="w-4 h-4 text-accent1" />
                  Send Broadcast Message
                </button>
                <button className="w-full p-3 rounded-lg bg-surfaceHover hover:bg-surfaceHover/80 transition-colors flex items-center gap-3 text-sm text-text">
                  <LayoutDashboard className="w-4 h-4 text-accent2" />
                  View Architecture
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>

      {/* Spawn Agent Modal */}
      {showSpawnModal && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="glass-card w-full max-w-md p-6 animate-slide-in">
            <h2 className="text-xl font-bold text-text mb-1">Spawn New Agent</h2>
            <p className="text-textMuted text-sm mb-6">
              Create a new agent to handle a specific task
            </p>
            
            <form onSubmit={handleSpawn} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-text mb-1.5">
                  Agent Name
                </label>
                <input
                  type="text"
                  value={spawnName}
                  onChange={(e) => setSpawnName(e.target.value)}
                  placeholder="e.g., security-audit"
                  className="w-full"
                  required
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-text mb-1.5">
                  Task Description
                </label>
                <textarea
                  value={spawnTask}
                  onChange={(e) => setSpawnTask(e.target.value)}
                  placeholder="Describe what the agent should do..."
                  rows={3}
                  className="w-full resize-none"
                  required
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-text mb-1.5">
                  Priority
                </label>
                <select
                  value={spawnPriority}
                  onChange={(e) => setSpawnPriority(e.target.value)}
                  className="w-full"
                >
                  <option value="low">Low - Queue when available</option>
                  <option value="normal">Normal - Standard priority</option>
                  <option value="high">High - Process immediately</option>
                </select>
              </div>
              
              <div className="flex gap-3 pt-4">
                <button
                  type="button"
                  onClick={() => setShowSpawnModal(false)}
                  className="btn btn-secondary flex-1"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="btn btn-primary flex-1"
                >
                  <Plus className="w-4 h-4" />
                  Spawn Agent
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}

// Fetch data server-side so page loads with actual data
export const getServerSideProps: GetServerSideProps = async () => {
  try {
    const data = await getAllAgentData();
    return {
      props: {
        initialData: data,
      },
    };
  } catch (error) {
    console.error('Failed to fetch initial data:', error);
    return {
      props: {
        initialData: {
          agents: [],
          completed: [],
          pending: [],
          stats: {
            activeCount: 0,
            completedCount: 0,
            totalTokens: 0,
            maxParallel: 5,
            apiStatus: 'Error',
            cronStatus: 'Error',
            skillsAvailable: 0,
          },
          lastUpdated: new Date().toISOString(),
        },
      },
    };
  }
};