name: Deploy x402 Services

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - merchant
          - research
      platform:
        description: 'Deployment platform'
        required: true
        default: 'fly'
        type: choice
        options:
          - docker
          - railway
          - fly

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Fly CLI
        if: github.event.inputs.platform == 'fly' || github.event.inputs.platform == null
        run: |
          curl -L https://fly.io/install.sh | sh
          echo "$HOME/.fly/bin" >> $GITHUB_PATH

      - name: Install Railway CLI
        if: github.event.inputs.platform == 'railway'
        run: npm install -g @railway/cli

      - name: Create .env file
        run: |
          cat > .env << EOF
          MERCHANT_ADDRESS=${{ secrets.MERCHANT_ADDRESS }}
          WALLET_PRIVATE_KEY=${{ secrets.WALLET_PRIVATE_KEY }}
          BASE_RPC_URL=${{ secrets.BASE_RPC_URL }}
          SERPER_API_KEY=${{ secrets.SERPER_API_KEY }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          TWITTER_BEARER_TOKEN=${{ secrets.TWITTER_BEARER_TOKEN }}
          GITHUB_TOKEN=${{ secrets.GH_TOKEN }}
          EOF

      - name: Deploy to Fly.io
        if: github.event.inputs.platform == 'fly' || github.event.inputs.platform == null
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          SERVICE="${{ github.event.inputs.service || 'both' }}"
          ./deploy.sh "$SERVICE" fly

      - name: Deploy to Railway
        if: github.event.inputs.platform == 'railway'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          SERVICE="${{ github.event.inputs.service || 'both' }}"
          ./deploy.sh "$SERVICE" railway

      - name: Deploy locally (Docker)
        if: github.event.inputs.platform == 'docker'
        run: |
          SERVICE="${{ github.event.inputs.service || 'both' }}"
          ./deploy.sh "$SERVICE" docker

      - name: Test deployment
        run: |
          sleep 30
          ./scripts/test-deployment.sh || true